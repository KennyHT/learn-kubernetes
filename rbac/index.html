



<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-3.0.4">
    
    
      
        <title>RBAC - Learn Kubernetes</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.451f80e5.css">
      
        <link rel="stylesheet" href="../assets/stylesheets/application-palette.22915126.css">
      
      
        
        
        <meta name="theme-color" content="#3f51b5">
      
    
    
      <script src="../assets/javascripts/modernizr.1aa3b519.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="../#rbac" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href=".." title="Learn Kubernetes" class="md-header-nav__button md-logo">
          
            <i class="md-icon">class</i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                Learn Kubernetes
              </span>
              <span class="md-header-nav__topic">
                RBAC
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href=".." title="Learn Kubernetes" class="md-nav__button md-logo">
      
        <i class="md-icon">class</i>
      
    </a>
    Learn Kubernetes
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../setup/" title="Setup" class="md-nav__link">
      Setup
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../deploying-declaratively/" title="Deploying Declaratively" class="md-nav__link">
      Deploying Declaratively
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../reconciliation-loop-testing/" title="Reconciliation Loop Testing" class="md-nav__link">
      Reconciliation Loop Testing
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../kubectl/" title="Kubectl Essentials" class="md-nav__link">
      Kubectl Essentials
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../namespaces/" title="Namespaces" class="md-nav__link">
      Namespaces
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../pods/" title="Pods" class="md-nav__link">
      Pods
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../configmaps/" title="ConfigMaps" class="md-nav__link">
      ConfigMaps
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../secrets/" title="Secrets" class="md-nav__link">
      Secrets
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../services/" title="Services" class="md-nav__link">
      Services
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../replicasets/" title="ReplicaSets" class="md-nav__link">
      ReplicaSets
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../deployments/" title="Deployments" class="md-nav__link">
      Deployments
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        RBAC
      </label>
    
    <a href="./" title="RBAC" class="md-nav__link md-nav__link--active">
      RBAC
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#get-set-up" title="Get set up" class="md-nav__link">
    Get set up
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creating-a-new-user" title="Creating a new user" class="md-nav__link">
    Creating a new user
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-1-create-the-client-key-and-signing-request" title="Step 1. Create the client key and signing request" class="md-nav__link">
    Step 1. Create the client key and signing request
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-2-download-the-cluster-ca-certificate-and-key" title="Step 2. Download the cluster CA certificate and key" class="md-nav__link">
    Step 2. Download the cluster CA certificate and key
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#docker-for-desktop" title="Docker for Desktop" class="md-nav__link">
    Docker for Desktop
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minikube" title="Minikube" class="md-nav__link">
    Minikube
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-3-sign-the-csr-using-the-cluster-certificate-authority-ca" title="Step 3. Sign the CSR using the cluster Certificate Authority (CA)" class="md-nav__link">
    Step 3. Sign the CSR using the cluster Certificate Authority (CA)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-4-add-a-new-context-using-the-learn-k8s-user" title="Step 4. Add a new context using the learn-k8s user" class="md-nav__link">
    Step 4. Add a new context using the learn-k8s user
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-5-provide-access-to-our-learn-k8s-user" title="Step 5. Provide access to our learn-k8s user" class="md-nav__link">
    Step 5. Provide access to our learn-k8s user
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-6-check-our-access" title="Step 6. Check our access" class="md-nav__link">
    Step 6. Check our access
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-7-clean-up" title="Step 7. Clean-up" class="md-nav__link">
    Step 7. Clean-up
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#get-set-up" title="Get set up" class="md-nav__link">
    Get set up
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creating-a-new-user" title="Creating a new user" class="md-nav__link">
    Creating a new user
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-1-create-the-client-key-and-signing-request" title="Step 1. Create the client key and signing request" class="md-nav__link">
    Step 1. Create the client key and signing request
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-2-download-the-cluster-ca-certificate-and-key" title="Step 2. Download the cluster CA certificate and key" class="md-nav__link">
    Step 2. Download the cluster CA certificate and key
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#docker-for-desktop" title="Docker for Desktop" class="md-nav__link">
    Docker for Desktop
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#minikube" title="Minikube" class="md-nav__link">
    Minikube
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-3-sign-the-csr-using-the-cluster-certificate-authority-ca" title="Step 3. Sign the CSR using the cluster Certificate Authority (CA)" class="md-nav__link">
    Step 3. Sign the CSR using the cluster Certificate Authority (CA)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-4-add-a-new-context-using-the-learn-k8s-user" title="Step 4. Add a new context using the learn-k8s user" class="md-nav__link">
    Step 4. Add a new context using the learn-k8s user
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-5-provide-access-to-our-learn-k8s-user" title="Step 5. Provide access to our learn-k8s user" class="md-nav__link">
    Step 5. Provide access to our learn-k8s user
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-6-check-our-access" title="Step 6. Check our access" class="md-nav__link">
    Step 6. Check our access
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-7-clean-up" title="Step 7. Clean-up" class="md-nav__link">
    Step 7. Clean-up
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="rbac">RBAC<a class="headerlink" href="#rbac" title="Permanent link">&para;</a></h1>
<p>Role-Based Access Control (RBAC) controls access to the Kubernetes API and restricts what objects in what namespaces an authenticated user is authorizd to access.</p>
<p><code>RBAC</code> has been GA in Kubernetes since 1.8 (late 2017) so most Kubernetes clusters have it enabled by default.</p>
<p>In this lab, we are going to create a new user that is restricted to accessing the <code>learn-k8s</code> Namespace and can only manage Deployments.</p>
<p>The use-case here is that the user (or deploy server) should not have the ability to modify environment configuration objects such as Services, ConfigMaps and Secrets. Those objects to be managed by a DevOps Engineer or SRE.</p>
<h2 id="get-set-up">Get set up<a class="headerlink" href="#get-set-up" title="Permanent link">&para;</a></h2>
<ul>
<li>Create a directory named <code>.kubecerts</code> in your home directory.</li>
<li>Ensure you have <code>openssl</code> installed.</li>
</ul>
<h2 id="creating-a-new-user">Creating a new user<a class="headerlink" href="#creating-a-new-user" title="Permanent link">&para;</a></h2>
<p>Kubernetes does not an API for managing Users but there are <a href="https://kubernetes.io/docs/admin/authentication">many ways Kubernetes can authenticate a user</a>. For this lab, we will be using client certificates.</p>
<h2 id="step-1-create-the-client-key-and-signing-request">Step 1. Create the client key and signing request<a class="headerlink" href="#step-1-create-the-client-key-and-signing-request" title="Permanent link">&para;</a></h2>
<p>We will create a new user with username <code>learn-k8s</code> in the <code>learn-k8s</code> group.</p>
<p>Change into the <code>~/.kubecerts/</code> directory, then generate the key:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>openssl genrsa -out learn-k8s.key 2048
</pre></div>
</td></tr></table>

<p>Now create a certificate signing request (CSR) using this private key. The <code>CN</code> key is for the user name and <code>O</code> is for the user's group:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>openssl req -new -key learn-k8s.key -out learn-k8s.csr -subj &quot;/CN=learn-k8s/O=learn-k8s&quot;
</pre></div>
</td></tr></table>

<h2 id="step-2-download-the-cluster-ca-certificate-and-key">Step 2. Download the cluster CA certificate and key<a class="headerlink" href="#step-2-download-the-cluster-ca-certificate-and-key" title="Permanent link">&para;</a></h2>
<p>The cluster's Certificate Authority (CA) is required for signing your CSR and generating the client certificates required for accessing the cluster.</p>
<p>To do this, you will need the CA certificate and key for your cluster.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Because this is a development environment and we're doing this for learning purposes, we will save the CA certificate and key from our cluster locally to make things easier.</p>
</div>
<h3 id="docker-for-desktop">Docker for Desktop<a class="headerlink" href="#docker-for-desktop" title="Permanent link">&para;</a></h3>
<p>The cluster certificates are in <code>/run/config/pki</code>. </p>
<p>Get the certificate contents and save it to <code>~/.kubecerts</code> as <code>ca.crt</code>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>make docker-vm-shell DOCKER_VM_CMD=&quot;cat /run/config/pki/ca.crt&quot;
</pre></div>
</td></tr></table>

<p>Get the key contents and save it to <code>~/.kubecerts</code> as <code>ca.key</code>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>make docker-vm-shell DOCKER_VM_CMD=&quot;cat /run/config/pki/ca.key
</pre></div>
</td></tr></table>

<h3 id="minikube">Minikube<a class="headerlink" href="#minikube" title="Permanent link">&para;</a></h3>
<p>From the <code>minikube</code> directory, download the <code>ca.crt</code> and <code>ca.key</code> to the <code>~/.kubecerts</code> directory.</p>
<h2 id="step-3-sign-the-csr-using-the-cluster-certificate-authority-ca">Step 3. Sign the CSR using the cluster Certificate Authority (CA)<a class="headerlink" href="#step-3-sign-the-csr-using-the-cluster-certificate-authority-ca" title="Permanent link">&para;</a></h2>
<p>Now that we have downloaded the CA cert and key from the cluster, we can create the final certificate to give us access to the cluster:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>openssl x509 -req -in ~/.kubecerts/learn-k8s.csr -CA ~/.kubecerts/ca.crt -CAkey ~/.kubecerts/ca.key -CAcreateserial -out ~/.kubecerts/learn-k8s.crt -days 500
</pre></div>
</td></tr></table>

<h2 id="step-4-add-a-new-context-using-the-learn-k8s-user">Step 4. Add a new context using the learn-k8s user<a class="headerlink" href="#step-4-add-a-new-context-using-the-learn-k8s-user" title="Permanent link">&para;</a></h2>
<p>Add the learn-k8s user to your kubectl config (you need to provide the absolute path to your home directory):</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>kubectl config set-credentials learn-k8s --client-certificate=/home/path/.kubecerts/learn-k8s.crt  --client-key=/home/path/.kubecerts/learn-k8s.key
</pre></div>
</td></tr></table>

<p>Now create the context using either <code>minikube</code> or <code>docker-for-desktop-cluster</code> as the $CLUSTER_NAME:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>kubectl config set-context learn-k8s-deployer --cluster=$CLUSTER_NAME --namespace=learn-k8s --user=learn-k8s
</pre></div>
</td></tr></table>

<p>Now try to get a list of Pods using this context:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>kubectl --context=learn-k8s-deployer get pods
</pre></div>
</td></tr></table>

<p>This fails because we haven't <strong>bound</strong> this ser to a Role.</p>
<h2 id="step-5-provide-access-to-our-learn-k8s-user">Step 5. Provide access to our learn-k8s user<a class="headerlink" href="#step-5-provide-access-to-our-learn-k8s-user" title="Permanent link">&para;</a></h2>
<p>Create the Role:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>kubectl apply -f manifests/rbac-role.yaml
</pre></div>
</td></tr></table>

<p>Then create the RoleBinding:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>kubectl apply -f manifests/rbac-rolebinding.yaml
</pre></div>
</td></tr></table>

<h2 id="step-6-check-our-access">Step 6. Check our access<a class="headerlink" href="#step-6-check-our-access" title="Permanent link">&para;</a></h2>
<p>Now let's try to list the Pods and Deployments using our new context:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>kubectl --context=learn-k8s-deployer get pods
kubectl --context=learn-k8s-deployer get deployments.apps
</pre></div>
</td></tr></table>

<p>What about secrets?</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>kubectl --context=learn-k8s-deployer get secrets
</pre></div>
</td></tr></table>

<p>Just as we expected, we do not have access to Secrets.</p>
<h2 id="step-7-clean-up">Step 7. Clean-up<a class="headerlink" href="#step-7-clean-up" title="Permanent link">&para;</a></h2>
<p>Delete the <code>~/.kubecerts</code> folder.</p>
<p>Remove the learn-k8s user:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>kubectl config unset users.learn-k8s
</pre></div>
</td></tr></table>

<p>Remove the context:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>kubectl config unset contexts.learn-k8s-deployer
</pre></div>
</td></tr></table>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../deployments/" title="Deployments" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Deployments
              </span>
            </div>
          </a>
        
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.583bbe55.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
    
    
      
    
  </body>
</html>